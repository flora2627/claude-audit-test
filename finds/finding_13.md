## æ ‡é¢˜
`voter::reset_internal` åœ¨å¤„ç†å·² `kill` çš„ gauge æ—¶å­˜åœ¨é€»è¾‘ç¼ºé™·ï¼Œå¯¼è‡´ `total_weights_per_epoch` è¢«æ°¸ä¹…æ±¡æŸ“ï¼Œå¼•å‘å¥–åŠ±å‡å°‘ ğŸš¨

## ç±»å‹
Inconsistency / Mis-measurement

## é£é™©ç­‰çº§
High

## ä½ç½®
- `sources/voter.move`: `reset_internal` å‡½æ•° (L1481-L1553), ç‰¹åˆ«æ˜¯ L1519 çš„æ¡ä»¶æ£€æŸ¥ã€‚

## å‘ç°ä¾æ®
1.  **ä¸ä¸€è‡´çš„ä¼šè®¡é€»è¾‘**: `voter` æ¨¡å—åœ¨å¢åŠ å’Œå‡å°‘æ€»æŠ•ç¥¨æƒé‡æ—¶éµå¾ªäº†ä¸åŒçš„è§„åˆ™ã€‚
    *   **å¢åŠ æƒé‡ (`vote_internal`)**: å½“ç”¨æˆ·æŠ•ç¥¨æ—¶ï¼Œæ‰€æœ‰æŠ•å‘ `is_alive` gauge çš„æƒé‡éƒ½ä¼šè¢«ç´¯åŠ åˆ° `weights_per_epoch` å’Œ `total_weights_per_epoch` ä¸­ã€‚
    *   **å‡å°‘æƒé‡ (`reset_internal`)**: å½“ç”¨æˆ·é‡ç½®æŠ•ç¥¨æ—¶ï¼Œå‡½æ•°ä¼šéå†ç”¨æˆ·ä¹‹å‰çš„æ‰€æœ‰æŠ•ç¥¨ã€‚ä½†åœ¨è®¡ç®—è¦ä» `total_weights_per_epoch` ä¸­å‡å»çš„æ€»æƒé‡æ—¶ï¼Œå®ƒ**åª**ç´¯åŠ é‚£äº›å½“å‰ä»ç„¶ `is_alive` çš„ gauge çš„æƒé‡ (L1519: `if (*table::borrow(&voter.is_alive, *gauge))`)ã€‚

2.  **çŠ¶æ€ä¸ä¸€è‡´çš„è§¦å‘**: å¦‚æœä¸€ä¸ª gauge åœ¨ç”¨æˆ·æŠ•ç¥¨åã€ä½†åœ¨ç”¨æˆ·é‡ç½®æŠ•ç¥¨å‰è¢« `kill`ï¼Œå°±ä¼šè§¦å‘è¿™ä¸ªé€»è¾‘ç¼ºé™·ã€‚`reset_internal` å°†ä¸ä¼šæŠŠæŠ•ç»™è¿™ä¸ªå·² `kill` çš„ gauge çš„æƒé‡ä» `total_weights_per_epoch` ä¸­å‡å»ã€‚

3.  **æ°¸ä¹…æ€§æ±¡æŸ“**: `total_weights_per_epoch` æ˜¯ä¸€ä¸ªå…³é”®çš„äºŒçº§æŒ‡æ ‡ï¼Œå®ƒè¢«äººä¸ºåœ°å¤¸å¤§äº†ã€‚è¿™ä¸ªå¤šå‡ºæ¥çš„â€œå¹½çµæƒé‡â€æ²¡æœ‰å¯¹åº”çš„ `weights_per_epoch` æ¡ç›®ï¼Œå› æ­¤ `total_weights_per_epoch` ä¸å†ç­‰äº `sum(weights_per_epoch[epoch])`ï¼Œç ´åäº†ä¼šè®¡æ’ç­‰å¼ã€‚ç”±äºæ²¡æœ‰æœºåˆ¶å¯ä»¥æ¸…ç†è¿™ä¸ªå·®é¢ï¼Œè¿™ç§æ±¡æŸ“æ˜¯æ°¸ä¹…æ€§çš„ã€‚

## æ”»å‡»è·¯å¾„
1.  **åˆå§‹çŠ¶æ€**: å­˜åœ¨ä¸¤ä¸ª `alive` çš„ gauge G1 å’Œ G2ï¼Œå®ƒä»¬å¯¹åº”çš„æ± å­ä¸º P1 å’Œ P2ã€‚
2.  **æŠ•ç¥¨**: ç”¨æˆ· Alice è°ƒç”¨ `vote(token, [P1, P2], [50, 50])`ï¼Œå°†å…¶ veNFT çš„æƒé‡å¹³å‡åˆ†é…ç»™ä¸¤ä¸ªæ± å­ã€‚
    *   `total_weights_per_epoch` å¢åŠ äº† `W1 + W2`ã€‚
3.  **æ²»ç†æ“ä½œ**: Governance è°ƒç”¨ `kill_gauge(G2)`ï¼Œå°† G2 çš„çŠ¶æ€è®¾ç½®ä¸º `is_alive = false`ã€‚
4.  **è§¦å‘æ¼æ´**: Alice è°ƒç”¨ `reset(token)` æˆ– `vote(...)` æ¥ä¿®æ”¹å¥¹çš„æŠ•ç¥¨ã€‚
    *   `reset_internal` è¢«è§¦å‘ã€‚
    *   å‡½æ•°éå† Alice çš„æ—§æŠ•ç¥¨ (P1, P2)ã€‚
    *   å¯¹äº P1 (alive)ï¼Œå…¶æƒé‡ W1 è¢«åŠ åˆ°å±€éƒ¨å˜é‡ `total_weight`ã€‚
    *   å¯¹äº P2 (killed)ï¼Œ`if` æ¡ä»¶ (L1519) ä¸º `false`ï¼Œå…¶æƒé‡ W2 **è¢«å¿½ç•¥**ã€‚
    *   æœ€ç»ˆï¼Œ`total_weights_per_epoch` ä»…è¢«å‡å»äº† W1ã€‚
5.  **ç»“æœ**: `total_weights_per_epoch` ä¸­æ°¸ä¹…æ®‹ç•™äº† W2 çš„â€œå¹½çµæƒé‡â€ã€‚

## å½±å“
- **èµ„äº§æŸå¤± (Loss)**: è¢«å¤¸å¤§çš„ `total_weights_per_epoch` åœ¨ `notify_reward_amount` å‡½æ•° (L1044) ä¸­è¢«ç”¨ä½œåˆ†æ¯æ¥è®¡ç®—å¥–åŠ±åˆ†é…æ¯”ç‡ `ratio`ã€‚
    ```1050:1053:sources/voter.move
    let scaled_ratio = (amount as u256) * (DXLYN_DECIMAL as u256)
        / (total_weight as u256);
    ratio = (scaled_ratio as u64);
    ```
    ä¸€ä¸ªè™šé«˜çš„åˆ†æ¯ä¼šå¯¼è‡´è®¡ç®—å‡ºçš„ `ratio` åä½ï¼Œä»è€Œä½¿å…¨å±€å¥–åŠ±æŒ‡æ•° `voter.index` å¢é•¿æ”¾ç¼“ã€‚è¿™ç›´æ¥å¯¼è‡´æ¯å‘¨åˆ†é…ç»™**æ‰€æœ‰** gauge çš„ `claimable` å¥–åŠ±æ€»é¢å‡å°‘ã€‚
- **æ°¸ä¹…æ€§èµ„é‡‘å†»ç»“**: å‡å°‘çš„è¿™éƒ¨åˆ†å¥–åŠ±å¹¶æ²¡æœ‰æ¶ˆå¤±ï¼Œè€Œæ˜¯å› ä¸ºæ— æ³•è¢«æ­£ç¡®åˆ†é…è€Œ**æ°¸ä¹…æ»ç•™**åœ¨ `voter` åˆçº¦ä¸­ï¼Œæ— æ³•è¢«ä»»ä½• LP é¢†å–ã€‚è¿™å®è´¨ä¸Šæ˜¯å¯¹æ‰€æœ‰ LP ä¾›åº”å•†çš„èµ„äº§æŸå¤±ã€‚

## æ ¹å› æ ‡ç­¾
`Inconsistency` / `Mis-measurement`

## çŠ¶æ€
Confirmed
