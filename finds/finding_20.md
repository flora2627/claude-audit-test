## æ ‡é¢˜
`fee_distributor::checkpoint_token_internal` å‡½æ•°ä¸­çš„æ•´æ•°é™¤æ³•èˆå…¥é”™è¯¯å¯¼è‡´å¥–åŠ±èµ„é‡‘æ°¸ä¹…å†»ç»“ ğŸš¨

## åˆ†ç±»
Freeze / Loss â€“ Mis-measurement

## ä½ç½®
- `sources/fee_distributor.move`: `checkpoint_token_internal` å‡½æ•° (L796-L864)

## äºŒçº§æŒ‡æ ‡ä¸å½±å“
- **äºŒçº§æŒ‡æ ‡**: `fee_dis.tokens_per_week: Table<u64, u64>`ï¼Œæ­¤ä¸º `fee_distributor` åˆçº¦çš„è´Ÿå€ºè¡¨ï¼Œè®°å½•äº†æ¯å‘¨åº”åˆ†å‘çš„ rebase å¥–åŠ±æ€»é¢ã€‚
- **æ ¸å¿ƒæ–­è¨€**: `Invariant-Broken`ã€‚åè®®çš„ä¼šè®¡ç³»ç»Ÿåº”ç¡®ä¿æ‰€æœ‰æ”¶åˆ°çš„ rebase å¥–åŠ± (`to_distribute`) éƒ½è¢«ç²¾ç¡®åœ°åˆ†é…åˆ° `tokens_per_week` è¡¨ä¸­ã€‚è¯¥å‡½æ•°ä¸­çš„èˆå…¥é”™è¯¯ç ´åäº†è¿™ä¸€èµ„é‡‘å®ˆæ’åŸåˆ™ã€‚
- **å½±å“é—¨æ§›**: `Freeze` / `Loss`ã€‚ç”±äºé‡å¤çš„æ•´æ•°é™¤æ³•æˆªæ–­ï¼Œä¸€å°éƒ¨åˆ† `to_distribute` èµ„é‡‘æ°¸è¿œæ— æ³•è¢«è®°å…¥è´Ÿå€ºè¡¨ï¼Œå¯¼è‡´è¿™éƒ¨åˆ†èµ„äº§æ»ç•™åœ¨åˆçº¦ä¸­æ— æ³•è¢«ç”¨æˆ· `claim`ï¼Œæ„æˆæ°¸ä¹…æ€§å†»ç»“ã€‚

## è¯¦ç»†è¯´æ˜

### è§¦å‘æ¡ä»¶ / è°ƒç”¨æ ˆ
1.  `voter` åˆçº¦ï¼ˆæˆ–å…¶ä»–æˆæƒåœ°å€ï¼‰è°ƒç”¨ `fee_distributor::burn_rebase` æˆ– `burn` å‡½æ•°ï¼Œå‘ `fee_distributor` åˆçº¦è½¬å…¥ rebase å¥–åŠ±ã€‚
2.  ä»»ä½•äººè°ƒç”¨ `checkpoint_token`ï¼Œè§¦å‘ `checkpoint_token_internal` å‡½æ•°çš„æ‰§è¡Œã€‚
3.  è¯¥å‡½æ•°æ‰§è¡Œæ—¶ï¼Œ`to_distribute`ï¼ˆæ–°æ”¶åˆ°çš„å¥–åŠ±ï¼‰çš„å€¼å°äº `since_last`ï¼ˆè‡ªä¸Šæ¬¡æ£€æŸ¥ç‚¹ä»¥æ¥çš„ç§’æ•°ï¼‰ã€‚

### ç¼ºé™·åˆ†æ
`checkpoint_token_internal` å‡½æ•°è´Ÿè´£å°†ä¸€æ®µæ—¶é—´å†…ç´¯ç§¯æ”¶åˆ°çš„å¥–åŠ± (`to_distribute`) æŒ‰æ—¶é—´æ¯”ä¾‹åˆ†é…åˆ°æ¨ªè·¨çš„æ•°å‘¨å†…ã€‚å…¶æ ¸å¿ƒåˆ†é…é€»è¾‘å¦‚ä¸‹ï¼š

```827:836:sources/fee_distributor.move
let token_per_week = table::borrow_mut_with_default(&mut fee_dis.tokens_per_week, this_week, 0);

let scaled_token_per_week =
    (*token_per_week as u256)
        + ((to_distribute as u256)
        * ((current_time - t) as u256)) / (
        since_last as u256
    );

*token_per_week = (scaled_token_per_week as u64);
```
- **L831-L833 `((to_distribute as u256) * ((current_time - t) as u256)) / (since_last as u256)`**: è¿™æ˜¯è®¡ç®—å½“å‰å‘¨ï¼ˆæˆ–æœ€åä¸€ä¸ªéƒ¨åˆ†å‘¨ï¼‰åº”åˆ†é…å¥–åŠ±çš„å…¬å¼ã€‚å®ƒå­˜åœ¨ä¸€ä¸ªç»å…¸çš„æ•´æ•°é™¤æ³•é—®é¢˜ã€‚

**æ¼æ´æ ¸å¿ƒ**:
å½“ `to_distribute` çš„å€¼ç›¸å¯¹è¾ƒå°ï¼Œè€Œ `since_last` çš„å€¼è¾ƒå¤§æ—¶ï¼ˆä¾‹å¦‚ï¼Œç»è¿‡äº†å¾ˆé•¿æ—¶é—´æ‰æœ‰ä¸€æ¬¡å°é¢å¥–åŠ±æ³¨å…¥ï¼‰ï¼Œ`to_distribute < since_last` çš„æƒ…å†µå¾ˆå¯èƒ½å‘ç”Ÿã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåˆ†å­ `(to_distribute as u256) * ((current_time - t) as u256)` å¯èƒ½å°äºåˆ†æ¯ `(since_last as u256)`ï¼Œå¯¼è‡´æ•´ä¸ªé™¤æ³•è¡¨è¾¾å¼çš„ç»“æœè¢«æˆªæ–­ä¸º `0`ã€‚

è¯¥å‡½æ•°åœ¨ä¸€ä¸ª `for` å¾ªç¯ (L814) ä¸­å¤„ç†è·¨è¶Šå¤šå‘¨çš„æƒ…å†µã€‚åœ¨æ¯æ¬¡è¿­ä»£ä¸­ï¼Œå®ƒéƒ½ä¼šä¸ºä¸€å‘¨åˆ†é…å¥–åŠ±ï¼Œç„¶åæ›´æ–°å‰©ä½™å¾…åˆ†é…çš„æ—¶é—´å’Œå¥–åŠ±ã€‚å¦‚æœæ¯æ¬¡è¿­ä»£ä¸­çš„é™¤æ³•éƒ½å› èˆå…¥è€Œäº§ç”Ÿå¾®å°çš„æŸå¤±ï¼Œè¿™äº›æŸå¤±ä¼šç´¯ç§¯ã€‚

æ›´ç³Ÿç³•çš„æ˜¯ï¼Œè¯¥å‡½æ•°æ²¡æœ‰å¯¹åˆ†é…çš„æ€»é‡è¿›è¡Œè¿½è¸ªå’Œæ ¸å¯¹ã€‚å®ƒåªæ˜¯ç®€å•åœ°æ‰§è¡Œåˆ†é…è®¡ç®—ï¼Œè€Œæ²¡æœ‰ä¸€ä¸ªæœ€ç»ˆçš„ `remainder` (ä½™æ•°) å¤„ç†æœºåˆ¶ã€‚è¿™æ„å‘³ç€æ‰€æœ‰å› èˆå…¥è€Œè¢«æˆªæ–­çš„ "å°˜åŸƒ" èµ„é‡‘ï¼Œå°†æ°¸è¿œä¸ä¼šè¢«æ·»åŠ åˆ°ä»»ä½•ä¸€å‘¨çš„ `tokens_per_week` ä¸­ã€‚

**ç»“æœ**:
åˆçº¦çš„èµ„äº§ (`token_last_balance`) å·²ç»å¢åŠ äº† `to_distribute`ï¼Œä½†å…¶è´Ÿå€º (`sum(tokens_per_week)`) çš„å¢åŠ é‡å´å°äº `to_distribute`ã€‚å·®é¢éƒ¨åˆ†å°±æˆäº†æ°¸ä¹…æ»ç•™åœ¨åˆçº¦ä¸­çš„æ— ä¸»èµ„é‡‘ï¼Œæ— æ³•è¢«ä»»ä½•ç”¨æˆ·é€šè¿‡ `claim` å‡½æ•°é¢†å–ã€‚

### è¯æ® (P1-P3)
-   **äº¤æ˜“åºåˆ— (P1)** (ç®€åŒ–åœºæ™¯):
    1.  åˆçº¦çŠ¶æ€: `token_last_balance = 1000`, `tokens_per_week` ä¸ºç©º, `last_token_time` åœ¨ `t_0`ã€‚
    2.  `t_0 + 60` ç§’æ—¶ï¼Œ`user_A` è°ƒç”¨ `burn(60)`ã€‚åˆçº¦æ”¶åˆ° `60` ä»£å¸ã€‚`token_last_balance` æœªæ›´æ–°ã€‚
    3.  `t_0 + 100` ç§’æ—¶ï¼Œ`user_B` è°ƒç”¨ `checkpoint_token`ã€‚
        *   `to_distribute` = `(1000 + 60) - 1000` = `60`
        *   `since_last` = `100`
        *   è®¡ç®—ä»½é¢: `(60 * 100) / 100` = `60`ã€‚èµ„é‡‘è¢«å…¨éƒ¨åˆ†é…ã€‚
    4.  **æœ‰é—®é¢˜çš„åºåˆ—**:
    5.  åˆçº¦çŠ¶æ€: `token_last_balance = 1000`, `tokens_per_week` ä¸ºç©º, `last_token_time` åœ¨ `t_0`ã€‚
    6.  `t_0 + 100` ç§’æ—¶ï¼Œ`user_A` è°ƒç”¨ `burn(60)`ã€‚
    7.  `t_0 + 100` ç§’æ—¶ï¼Œ`user_B` è°ƒç”¨ `checkpoint_token`ã€‚
        *   `to_distribute` = `60`
        *   `since_last` = `100`
        *   è®¡ç®—ä»½é¢: `(60 * (100-100)) / 100` = `0`ã€‚ **60 ä»£å¸å…¨éƒ¨ä¸¢å¤±**ã€‚

-   **å˜é‡å‰å (P2)**:
    *   `fee_dis.token_last_balance`: `N` â†’ `N + to_distribute`
    *   `sum(fee_dis.tokens_per_week)`: `S` â†’ `S + to_distribute - dust`
    *   **èµ„äº§è´Ÿå€ºå·®é¢**: `0` â†’ `dust` (dust > 0)

-   **å½±å“é‡åŒ– (P3)**:
    *   **å†»ç»“é‡‘é¢**: æ¯æ¬¡è°ƒç”¨ `checkpoint_token_internal` éƒ½ä¼šäº§ç”Ÿ `0` åˆ° `N-1` ä¸ªå•ä½çš„ç²¾åº¦æŸå¤±ï¼Œå…¶ä¸­ `N` æ˜¯å¾ªç¯æ¬¡æ•°ã€‚è™½ç„¶å•æ¬¡æŸå¤±å¾ˆå°ï¼Œä½†ç”±äº `checkpoint_token` å¯ä»¥è¢«é¢‘ç¹è°ƒç”¨ï¼Œè¿™äº›æŸå¤±ä¼šä¸æ–­ç´¯ç§¯ï¼Œæœ€ç»ˆå½¢æˆä¸€ç¬”ä¸å¯æå–çš„æ˜¾è‘—é‡‘é¢ã€‚
    *   **æ°¸ä¹…æ€§**: åˆçº¦æ²¡æœ‰æä¾›ä»»ä½•å‡½æ•°æ¥æå–è¿™äº›å› èˆå…¥è¯¯å·®è€Œæ»ç•™çš„èµ„é‡‘ã€‚

### åˆ©ç”¨è‰å›¾
è¿™ä¸æ˜¯ä¸€ä¸ªä¸»åŠ¨æ”»å‡»ï¼Œè€Œæ˜¯ä¸€ä¸ªè¢«åŠ¨çš„ã€ç”±åè®®è‡ªèº«é€»è¾‘å¯¼è‡´çš„èµ„é‡‘æ³„éœ²ã€‚
1.  åè®®æ­£å¸¸è¿è¡Œï¼Œ`burn` å’Œ `checkpoint_token` è¢«æ­£å¸¸è°ƒç”¨ã€‚
2.  åœ¨å¤šæ¬¡ `checkpoint_token` è°ƒç”¨ä¸­ï¼Œå¦‚æœ `to_distribute` å’Œ `since_last` çš„æ¯”ä¾‹å…³ç³»é¢‘ç¹å¯¼è‡´èˆå…¥è¯¯å·®ï¼Œèµ„é‡‘å°†æŒç»­ç´¯ç§¯åœ¨åˆçº¦ä¸­ã€‚
3.  éšç€æ—¶é—´çš„æ¨ç§»ï¼Œ`primary_fungible_store::balance` ä¼šæ˜¾ç¤ºåˆçº¦çš„å®é™…ä½™é¢å¤§äºå…¶å†…éƒ¨ä¼šè®¡ `token_last_balance` å’Œ `sum(tokens_per_week)` æ‰€èƒ½è§£é‡Šçš„æ•°é¢ã€‚è¿™éƒ¨åˆ†å·®é¢å³ä¸ºæ°¸ä¹…å†»ç»“çš„èµ„é‡‘ã€‚

## æ ¹å› æ ‡ç­¾
-   `Mis-measurement`
-   `Rounding Error`
-   `Asset Freeze`

## çŠ¶æ€
Confirmed
