## æ ‡é¢˜
`gauge_clmm` ä¼šè®¡ä¸å¤–éƒ¨æµåŠ¨æ€§è„±é’©ï¼Œå…è®¸é€šè¿‡æ“çºµ NFT ä»“ä½çªƒå–å¥–åŠ± ğŸš¨

## åˆ†ç±»
Loss â€“ Inconsistent State Handling / External State Dependency

## ä½ç½®
- `sources/gauge_clmm.move`: `deposit` (L300), `withdraw` (L345)

## äºŒçº§æŒ‡æ ‡ä¸å½±å“
- **äºŒçº§æŒ‡æ ‡**: `gauge.balances: Table<address, u128>` å’Œ `gauge.total_supply: u128`ã€‚è¿™ä¸¤ä¸ªæŒ‡æ ‡æ˜¯å¥–åŠ±è®¡ç®—çš„æ ¸å¿ƒä¼šè®¡åŸºç¡€ï¼Œæœ¬åº”å‡†ç¡®åæ˜ ç”¨æˆ·è´¨æŠ¼èµ„äº§çš„ä»·å€¼ã€‚
- **æ ¸å¿ƒæ–­è¨€**: `S-L3 (è·¨å£å¾„æ¬ç§»)` / `Invariant-Broken`ã€‚`gauge` åˆçº¦å†…éƒ¨è®°å½•çš„ç”¨æˆ·ä»½é¢ (`balance`) å¿…é¡»å§‹ç»ˆä¸ç”¨æˆ·å®é™…è´¨æŠ¼åœ¨åˆçº¦ä¸­çš„ NFT çš„æµåŠ¨æ€§ä»·å€¼ä¿æŒåŒæ­¥ã€‚æ­¤æ¼æ´ç ´åäº†è¿™ä¸€æ ¸å¿ƒä¸å˜é‡ã€‚
- **å½±å“é—¨æ§›**: `Loss`ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨å†…å¤–çŠ¶æ€çš„ä¸ä¸€è‡´ï¼Œä»¥æå°çš„å®é™…èµ„æœ¬è´¡çŒ®ï¼Œè·å–ä¸å…¶åä¹‰ä»½é¢ï¼ˆè™šé«˜ï¼‰ç›¸åŒ¹é…çš„å·¨é¢å¥–åŠ±ï¼Œä»è€Œç›—å–æœ¬åº”å±äºå…¶ä»–è¯šå®æµåŠ¨æ€§æä¾›è€…çš„èµ„é‡‘ã€‚

## è¯¦ç»†è¯´æ˜

### è§¦å‘æ¡ä»¶ / è°ƒç”¨æ ˆ
1.  æ”»å‡»è€…åœ¨ `dexlyn_clmm` åè®®ä¸­åˆ›å»ºä¸€ä¸ªå…·æœ‰é«˜æµåŠ¨æ€§ (`L_high`) çš„ NFT ä»“ä½ã€‚
2.  æ”»å‡»è€…è°ƒç”¨ `gauge_clmm::deposit`ï¼Œå°†æ­¤ NFT å­˜å…¥ `gauge`ã€‚
3.  æ”»å‡»è€…ä¸ `dexlyn_clmm` åè®®ç›´æ¥äº¤äº’ï¼Œè°ƒç”¨ `decrease_liquidity`ï¼ˆæˆ–ç±»ä¼¼å‡½æ•°ï¼‰æ¥å¤§å¹…é™ä½å…¶ NFT çš„æµåŠ¨æ€§è‡³ `L_low`ï¼Œå¹¶å–å›å¤§éƒ¨åˆ† underlying assetsã€‚
4.  æ”»å‡»è€…ç­‰å¾…ä¸€æ®µæ—¶é—´ä»¥ç´¯ç§¯å¥–åŠ±ã€‚
5.  æ”»å‡»è€…è°ƒç”¨ `gauge_clmm::get_reward` æ”¶è·ä¸å½“å¾—åˆ©ï¼Œå¹¶å¯é€‰æ‹©æ€§åœ°è°ƒç”¨ `withdraw` å–å› NFTã€‚

### ç¼ºé™·åˆ†æ
`gauge_clmm` åˆçº¦çš„ä¼šè®¡ç³»ç»Ÿå­˜åœ¨ä¸€ä¸ªæ ¹æœ¬æ€§çš„è®¾è®¡ç¼ºé™·ï¼šå®ƒå°† NFT çš„æµåŠ¨æ€§è§†ä¸ºä¸€ä¸ªé™æ€å€¼ï¼Œè€Œå®é™…ä¸Šå®ƒæ˜¯ä¸€ä¸ªå¯ä»¥è¢«å¤–éƒ¨åˆçº¦æ”¹å˜çš„åŠ¨æ€å€¼ã€‚

-   **`deposit` å‡½æ•°çš„é”™è¯¯å‡è®¾ (L300)**:
    ```315:326:sources/gauge_clmm.move
    let liquidity = get_liquidity(gauge.pool, token_address);
    assert!(liquidity > 0, ERROR_AMOUNT_MUST_BE_GREATER_THEN_ZERO);

    // ...
    //update user balance
    let balance = table::borrow_mut_with_default(&mut gauge.balances, user_address, 0);
    *balance = *balance + liquidity;

    //update total supply
    gauge.total_supply = gauge.total_supply + liquidity;
    ```
    åœ¨å­˜æ¬¾æ—¶ï¼Œåˆçº¦é€šè¿‡ `get_liquidity` è·å– NFT *å½“å‰*çš„æµåŠ¨æ€§ï¼Œå¹¶å°†å…¶è®°å…¥è´¦æœ¬ (`balances` å’Œ `total_supply`)ã€‚è¿™æ˜¯ä¸€ä¸ª**ä¸€æ¬¡æ€§çš„å¿«ç…§**ï¼Œåˆçº¦æ­¤åä¾¿å‡è®¾ç”¨æˆ·çš„è´¡çŒ®å€¼å°±æ˜¯è¿™ä¸ªæ•°ï¼Œå¹¶åŸºäºå®ƒæ¥è®¡ç®—å¥–åŠ±ã€‚

-   **ç¼ºä¹çŠ¶æ€åŒæ­¥æœºåˆ¶**: åˆçº¦å®Œå…¨æ²¡æœ‰æä¾›ä»»ä½•å‡½æ•°æˆ–æœºåˆ¶æ¥å®šæœŸæˆ–åœ¨å…³é”®æ“ä½œï¼ˆå¦‚ `update_reward`ï¼‰å‰é‡æ–°æ£€æŸ¥å·²å­˜å…¥ NFT çš„å®é™…æµåŠ¨æ€§ã€‚å®ƒç›²ç›®åœ°ä¿¡ä»»å­˜æ¬¾æ—¶çš„åˆå§‹å¿«ç…§ã€‚

-   **`withdraw` å‡½æ•°åŠ å‰§é—®é¢˜ (L345)**:
    ```373:386:sources/gauge_clmm.move
    let liquidity = get_liquidity(gauge.pool, token_address);
    // ...
    //update user balance
    let balance = table::borrow_mut(&mut gauge.balances, user_address);
    assert!(*balance >= liquidity, ERROR_INSUFFICIENT_BALANCE);
    *balance = *balance - liquidity;

    //update total supply
    gauge.total_supply = gauge.total_supply - liquidity;
    ```
    å–æ¬¾æ—¶ï¼Œåˆçº¦ä¼šé‡æ–°è·å– NFT çš„*å½“å‰*æµåŠ¨æ€§ `L_low`ï¼Œå¹¶ä»ç”¨æˆ·çš„ `balance` å’Œ `total_supply` ä¸­å‡å»è¿™ä¸ªè¾ƒå°çš„å€¼ã€‚è¿™å¯¼è‡´æ”»å‡»è€…çš„ `balance` åœ¨å–æ¬¾åä»ç„¶ä¸ºä¸€ä¸ªå·¨å¤§çš„æ­£æ•° (`L_high - L_low`)ï¼Œä½†è¿™ç¬”â€œå¹½çµâ€æµåŠ¨æ€§å¹¶ä¸å­˜åœ¨ï¼Œå®ƒä¼šæ°¸ä¹…æ€§åœ°æ±¡æŸ“ `total_supply`ï¼ŒæŒç»­ç¨€é‡Šå…¶ä»–æ‰€æœ‰ç”¨æˆ·çš„å¥–åŠ±ã€‚

### è¯æ® (P1-P3)
-   **äº¤æ˜“åºåˆ— (P1)**:
    1.  Attacker: `clmm::mint(pool, 1_000_000)` â†’ è·å¾— `nft_A`ï¼ŒæµåŠ¨æ€§ `L_high = 1_000_000`ã€‚
    2.  Attacker: `gauge::deposit(gauge, nft_A)`ã€‚
    3.  Attacker: `clmm::decrease_liquidity(nft_A, 999_999)` â†’ `nft_A` çš„æµåŠ¨æ€§å˜ä¸º `L_low = 1`ã€‚
    4.  (æ—¶é—´æµé€ï¼Œå¥–åŠ±ç´¯ç§¯)
    5.  Attacker: `gauge::get_reward(gauge)` â†’ è·å¾—åŸºäº `1_000_000` ä»½é¢è®¡ç®—çš„å¥–åŠ±ã€‚

-   **å˜é‡å‰å (P2)**:
    *   **`deposit` å**:
        *   `gauge.balances[attacker]`: `0` â†’ `1,000,000`
        *   `gauge.total_supply`: `S` â†’ `S + 1,000,000`
    *   **`decrease_liquidity` (å¤–éƒ¨) å**:
        *   `nft_A.liquidity`: `1,000,000` â†’ `1`
        *   `gauge.balances[attacker]`: `1,000,000` (æœªå˜)
        *   `gauge.total_supply`: `S + 1,000,000` (æœªå˜)
    *   **`get_reward` æ—¶**: å¥–åŠ±è®¡ç®—ä½¿ç”¨ `balance = 1,000,000`ï¼Œè€Œå®é™…è´¡çŒ®åªæœ‰ `1`ã€‚

-   **å½±å“é‡åŒ– (P3)**:
    *   **æŸå¤±é‡‘é¢**: æ”»å‡»è€…å¯ä»¥ä¸æˆæ¯”ä¾‹åœ°è·å¾—å¥–åŠ±ï¼Œå…¶çªƒå–çš„å¥–åŠ±ä»½é¢ä¸ `(L_high - L_low) / L_total` æˆæ­£æ¯”ã€‚å¦‚æœ `L_high` è¶³å¤Ÿå¤§ï¼Œæ”»å‡»è€…å¯ä»¥è¿‘ä¹ 100% åœ°æ”«å–åˆ†é…ç»™è¯¥ `gauge` çš„æ‰€æœ‰å¥–åŠ±ã€‚
    *   **åè®®å½±å“**: ç ´åäº† CLMM æ± çš„æµåŠ¨æ€§æ¿€åŠ±æœºåˆ¶ï¼Œè¯šå®ç”¨æˆ·å°†å› å¥–åŠ±è¢«ç¨€é‡Šè€Œé­å—æŸå¤±ã€‚

### åˆ©ç”¨è‰å›¾
è¿™æ˜¯ä¸€ä¸ªèµ„æœ¬æ•ˆç‡æé«˜çš„æ”»å‡»ã€‚
1.  **èµ„æœ¬æ³¨å…¥**: æ”»å‡»è€…ä½¿ç”¨é—ªç”µè´·æˆ–è‡ªæœ‰èµ„é‡‘ï¼Œä¸º CLMM æ± ä¸­çš„ä¸€ä¸ª NFT æ³¨å…¥å¤§é‡æµåŠ¨æ€§ (`L_high`)ã€‚
2.  **è´¨æŠ¼**: ç«‹å³å°†è¯¥ NFT å­˜å…¥ `gauge_clmm`ï¼Œä¸ºå…¶åœ¨ `gauge` çš„è´¦æœ¬ä¸Šé”å®šä¸€ä¸ªé«˜é¢çš„ `balance`ã€‚
3.  **èµ„æœ¬æ’¤å‡º**: ç«‹å³åœ¨ CLMM æ± ä¸­å‡å°‘è¯¥ NFT çš„æµåŠ¨æ€§è‡³ä¸€ä¸ªæå°å€¼ (`L_low`)ï¼Œå¹¶å½’è¿˜é—ªç”µè´·æˆ–æ”¶å›èµ„é‡‘ã€‚
4.  **åäº«å…¶æˆ**: æ”»å‡»è€…ä»¥å‡ ä¹ä¸ºé›¶çš„èµ„æœ¬æˆæœ¬ï¼Œä¿æŒç€ä¸€ä¸ªé«˜é¢çš„åä¹‰è´¨æŠ¼ä»½é¢ï¼ŒæŒç»­ä¸æ–­åœ°å¸èµ°æœ¬åº”åˆ†é…ç»™æ± ä¸­æ‰€æœ‰æµåŠ¨æ€§æä¾›è€…çš„å¥–åŠ±ã€‚

## æ ¹å› æ ‡ç­¾
-   `Inconsistent State Handling`
-   `External State Dependency`
-   `Mis-measurement`

## çŠ¶æ€
Confirmed
